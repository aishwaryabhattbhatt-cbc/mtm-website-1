---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navbar from '../components/ui/NavBar/nav-bar.astro';
import Grid from '../components/ui/Grid/grid.astro';
import HighlightText from '../components/ui/HighlightText/highlight-text.astro';
import Hero from '../components/home/1hero/hero.astro';
import WhyUs from '../components/home/2whyus/why-us.astro'; 
import Reports from '../components/home/3reports/reports.astro';
import Variables from '../components/home/4variables/variables.astro';
import Solutions from '../components/home/5solutions/solutions.astro';
import Products from '../components/home/6products/product.astro';
import AboutNews from '../components/home/7about-news/about-news.astro';
import CTA from "../components/ui/CTA/CTA.astro";
import Subscribe from '../components/ui/Subscribe/subscribe.astro';
import Footer from '../components/ui/Footer/footer.astro';
import Papa from 'papaparse';

// Hardcoded assets for the hero scene
const heroScene = {
  image: "/mtm-website-1/images/home/hero-woman-asian.webp",
  maskImage: "/mtm-website-1/images/home/hero-woman-asian-mask.webp",
  orbitBlocker: "/mtm-website-1/images/home/white-mask.png",
  
  centerOffset: { x: 0, y: 0 }, 
  orbits: [
    { radius: 190, delay: 1 },
    { radius: 260, delay: 1.5 },
    { radius: 330, delay: 2 },
  ],
  icons: [
    { file: "/mtm-website-1/icons/home/hero/icon-1.svg", orbit: 0, angle: 320, tooltip: "Audio Behavior" },
    { file: "/mtm-website-1/icons/home/hero/icon-2.svg", orbit: 1, angle: 210, tooltip: "Video Viewing" },
    { file: "/mtm-website-1/icons/home/hero/icon-3.svg", orbit: 2, angle: 170, tooltip: "Analytics" },
    { file: "/mtm-website-1/icons/home/hero/icon-4.svg", orbit: 2, angle: 350, tooltip: "Mobile Usage" }
  ]
};

// 1. Replace this with your "Published to Web" CSV URL
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPEomf-ND9rIvS3zuXP7if7TPShcpPwWU9Hn7ROXTRo9L47iZ0ezoLg8H-GYZTveEw7fAHDMn5A0iT/pub?gid=1604665094&single=true&output=csv";

const response = await fetch(SHEET_URL);
const csvData = await response.text();

// 2. Parsing logic
const parsed = Papa.parse(csvData, { 
  header: false, 
  skipEmptyLines: true 
});

// Improved parsing logic to handle values in different columns
const rawData = Object.fromEntries(
  parsed.data.map((row) => {
    const key = row[0]?.toString().trim().toLowerCase();
    // Filter out empty cells and take the second valid entry as the value
    const values = row.slice(1).filter(v => v && v.trim() !== "");
    const value = values[0]?.toString().trim() || ""; 
    return [key, value];
  })
);

// 3. Why us Animation Coordinate Map
const whyUsPanelConfig = {
  F1: {
    top:   { x: 50, y: 60 },  // Clustered start
    left:  { x: 40, y: 60 },
    right: { x: 60, y: 60 }
  },
  F2: { 
    top:   { x: 50, y: 20 },  // Above the card
    left:  { x: 15, y: 60 },  // Dead vertical center, 35% from midline
    right: { x: 85, y: 60 }   // Dead vertical center, 35% from midline
  }
};

const whyUsContent = {
  // Main Visual
  mainImage: "/mtm-website-1/Home-WhyUsImage.png",

  // Section Titles
  problemTitle: "PROBLEMS FACED",
  solutionTitle: "HOW WE SOLVE THEM",
  
  // Problems List
  problems: [
    { text: rawData["why_us_prob_1"], icon: "/mtm-website-1/icons/home/why-us/problem-1.svg" },
    { text: rawData["why_us_prob_2"], icon: "/mtm-website-1/icons/home/why-us/problem-2.svg" },
    { text: rawData["why_us_prob_3"], icon: "/mtm-website-1/icons/home/why-us/problem-3.svg" }
  ],
  
  // Solutions List
  solutions: [
    { text: rawData["why_us_sol_1"], icon: "/mtm-website-1/icons/home/why-us/solution-1.svg" },
    { text: rawData["why_us_sol_2"], icon: "/mtm-website-1/icons/home/why-us/solution-2.svg" },
    { text: rawData["why_us_sol_3"], icon: "/mtm-website-1/icons/home/why-us/solution-3.svg" }
  ]
};

const reportsScene = {
  mainImage: "/mtm-website-1/reports 1.png",
  footerSvg: "/mtm-website-1/report-stats.svg"
};

const solutionsContent = {
  titleHighlight: rawData["solutions_title_hl"] || "Solutions",
  titleBase: rawData["solutions_title_base"] || " for Every Decision Maker",
  description: rawData["solutions_desc"],
  roles: [
    { id: "advertising", label: "Advertising", desc: rawData["sol_advertising_desc"], cta: rawData["sol_advertising_cta"] },
    { id: "industry", label: "Industry", desc: rawData["sol_industry_desc"], cta: rawData["sol_industry_cta"] },
    { id: "media", label: "Media", desc: rawData["sol_media_desc"], cta: rawData["sol_media_cta"] },
    { id: "education", label: "Education", desc: rawData["sol_education_desc"], cta: rawData["sol_education_cta"] },
    { id: "govn", label: "Govn & NGO", desc: rawData["sol_govn_desc"], cta: rawData["sol_govn_cta"] },
  ]
};

const productsContent = {
  titleHighlight: rawData["products_title_hl"],
  titleBase: rawData["products_title_base"],
  description: rawData["products_desc"],
};

// Map CSV data to your existing product structure
const dynamicProductData = [
  { 
    id: "18", 
    subtitle: rawData["prod_18_subtitle"], 
    description: rawData["prod_18_desc"] 
  },
  { 
    id: "Jr", 
    subtitle: rawData["prod_jr_subtitle"], 
    description: rawData["prod_jr_desc"] 
  },
  { 
    id: "NC", 
    subtitle: rawData["prod_nc_subtitle"], 
    description: rawData["prod_nc_desc"] 
  },
  { 
    id: "Census", 
    subtitle: rawData["prod_census_subtitle"], 
    description: rawData["prod_census_desc"] 
  },
];

const aboutNewsLinks = {
  aboutHref: "/about-mtm",
  newsHref: "/newsroom"
};



---
<BaseLayout title="MTM | Home">
  <HighlightText />
  <Grid />
  <Navbar />
  
  <main class="page">
    <Hero 
      titleHighlight={rawData["home_titlehighlight"]}
      titleBase={rawData["home_titlebase"]}
      subtitle={rawData["home_subtitle"]}
      scene={heroScene} 
    />
    <WhyUs 
      heading={rawData["why_us_title"]}
      description={rawData["why_us_desc"]}
      panelPositions={whyUsPanelConfig}
      content={whyUsContent} 
    />
    <Reports 
      titleBase={rawData["reports_titlebase"]}
      titleHighlight={rawData["reports_titlehighlight"]}
      description={rawData["reports_desc"]}
      buttonText={rawData["reports_btn"]}
      statNumber={rawData["reports_stat_num"]}
      statLabel={rawData["reports_stat_label"]}
      scene={reportsScene}
    />
    <Variables 
      highlightText={rawData["variables_highlight"]}
      stackLine1={rawData["variables_stack1"]}
      stackLine2={rawData["variables_stack2"]}
      stackLine3={rawData["variables_stack3"]}
    />
    <Solutions content={solutionsContent} />
    <Products 
      titleHighlight={productsContent.titleHighlight}
      titleBase={productsContent.titleBase}
      description={productsContent.description}
      dynamicData={dynamicProductData}
    />
    <AboutNews  
    aboutTitle={rawData["about_title"]}
    aboutDesc={rawData["about_desc"]}
    aboutCta={rawData["about_cta"]}
    newsTitle={rawData["news_title"]}
    newsDesc={rawData["news_desc"]}
    newsCta={rawData["news_cta"]}
    links={aboutNewsLinks} 
  />
    <CTA />
    <Subscribe />
    <Footer />
  </main>
</BaseLayout>